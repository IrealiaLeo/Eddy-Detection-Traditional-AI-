# 基于物理-几何混合方法的海洋涡旋检测

本项目是对 Kang & Curchitser (2013) 在 *Journal of Geophysical Research: Oceans* 发表的论文《Gulf Stream eddy characteristics in a high-resolution ocean model》中所述涡旋检测算法的Python实现。

该算法采用一种混合方法，结合了基于物理参数（Okubo-Weiss, SSH）和基于流场几何特征的涡旋识别技术，以提高检测的准确性和鲁棒性。最终，项目将每日的海洋模式数据（如海面高度、速度场）处理成一个包含原始特征和涡旋标签（暖涡、冷涡、背景）的HDF5数据集，非常适合用于机器学习模型的训练。

## 核心思想与算法流程

算法的核心是通过两种独立但互补的方法识别涡旋中心的候选点，然后将它们融合、筛选并最终确定涡旋的边界。

1.  **物理参数候选**:
    *   **海面高度 (SSH)**: 暖涡（反气旋）中心对应于SSH的局部最大值，冷涡（气旋）中心对应于SSH的局部最小值。通过`find_local_extrema`函数在SSH场上寻找这些极值点。

2.  **流场几何特征候选**:
    *   **速度场**: 涡旋中心通常是速度幅值的局部最小值。
    *   **几何约束 (Nencioli et al., 2010)**: 在速度幅值局部最小点周围，施加一系列几何约束来确认为涡旋中心，例如：
        *   在穿过中心点的特定方向上，速度分量必须反向。
        *   邻域边界上的速度幅值比率必须在一定阈值（`ru`）内。
    *   该方法通过`find_velocity_minima`实现，并使用多尺度邻域（`nub_stack`）来增强检测的鲁棒性。

3.  **结果融合与筛选**:
    *   两种方法得到的候选点需要进行融合。本项目将速度法检测到的涡旋中心作为主要候选，并使用SSH极值点进行验证。
    *   **筛选**: 只保留那些与对应SSH极值点足够近的速度法候选中心。
    *   **去重**: 使用`KDTree`高效地移除彼此距离过近的候选中心，确保每个涡旋只被识别一次。
    *   这些步骤由`filter_and_deduplicate`函数完成。

4.  **涡旋边界与标签生成**:
    *   **Okubo-Weiss (OW) 参数**: OW参数用于衡量流场中旋转与变形的相对强度。涡旋核心区域通常对应于OW值小于某个负阈值（`ow0 = -0.2 * σ_ow`）的区域。
    *   **等值线**: 在OW场上提取满足上述条件的等值线，形成涡旋的潜在边界。
    *   **匹配与填充**: 将最终确定的涡旋中心与这些等值线进行匹配，只保留包含中心的等值线。然后，将这些闭合等值线内部的区域进行填充，生成标签矩阵（0: 背景, 1: 暖涡, 2: 冷涡）。
    *   此过程由`save_contour`函数完成。

## 文件结构

-   `main.py`: **主程序入口**。负责配置参数、循环处理数据、调度其他模块，并将最终的特征和标签保存到HDF5文件中。
-   `eddy.py`: **核心检测流程**。整合了单日涡旋检测的所有步骤，是连接数据输入和结果输出的桥梁。
-   `data_loader.py`: **数据加载器**。负责读取原始NetCDF格式的海洋数据，并根据指定的地理范围进行裁剪。
-   `ow.py`: **OW参数计算**。从速度场计算Okubo-Weiss参数、涡度以及标准化阈值。
-   `extrema.py`: **极值点检测**。包含两种涡旋中心候选点的检测方法：SSH局部极值检测和速度场几何约束检测。
-   `dedup.py`: **筛选与去重**。将不同来源的候选点进行融合、过滤和去重，得到最终的涡旋中心。
-   `contour.py`: **涡旋边界生成**。基于OW参数提取涡旋边界等值线，并生成用于机器学习的二维标签矩阵。
-   `preprocess.py`: **预处理模块**。包含对OW参数进行局部标准化等高级预处理函数。
-   `utils.py`: **通用工具**。提供一些辅助函数，如坐标索引查找。

## 如何运行

1.  **安装依赖**:
    确保已安装所有必需的Python库。推荐使用`pip`进行安装：
    ```bash
    pip install -r requirements.txt
    ```

2.  **配置参数**:
    打开 `main.py` 文件，根据需要修改顶部的全局配置参数：
    -   `HDF5_SAVE_PATH`: HDF5文件的保存目录。
    -   `HDF5_FILENAME`: 输出的HDF5文件名。
    -   `START_YEAR`, `END_YEAR`: 要处理的年份范围。
    -   `GEOGRAPHIC_EXTENT`: 目标海域的经纬度范围。
    -   `PARAMS_EDDY`: 涡旋检测算法的核心参数。

3.  **准备数据**:
    确保 `data_loader.py` 中的数据路径（`/home/kangdj/MOM6/NWA25/ocean_daily/`）是正确的，并且该路径下存放着对应年份的 `.nc` 数据文件。

4.  **执行脚本**:
    在终端中运行主程序：
    ```bash
    python main.py
    ```
    程序将按年份和日期顺序处理数据，并将结果实时追加到HDF5文件中。终端会显示处理进度。

## 输出说明

程序最终会生成一个HDF5文件（例如 `eddy_data_daily_raw_combined.h5`），其内部结构如下：

-   `/x` (Dataset): 中心网格的**经度**坐标 (float32)。
-   `/y` (Dataset): 中心网格的**纬度**坐标 (float32)。
-   `/time` (Dataset): **时间**坐标，格式为YYYYMMDD的整数 (int32)。
-   `/features` (Dataset): **特征数据**。一个四维数组 `(time, lat, lon, channels)`，其中 `channels` 按顺序包含 `u`, `v`, `velocity_mag`, `ow`, `vorticity`, `ssh` 的原始（未标准化）物理量。
-   `/labels` (Dataset): **标签数据**。一个三维数组 `(time, lat, lon)`，其值为 `0` (背景), `1` (暖涡), 或 `2` (冷涡)。
-   **Attributes**: 文件根目录包含元数据，如变量列表、类别名称、数据来源等。
